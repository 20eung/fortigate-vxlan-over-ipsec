# Terraform Source

## 1. Terraform Provider

```
terraform {
    required_providers {
      fortios   = {
            source      = "fortinetdev/fortios"
          }
    }
}

provider "fortios" { }
```

## 2. IPsec VPN Module

```
module "fg1-vpn" {

    source                = "./modules/ipsec_vpn"
    
    ### IPsec VPN Phase1-interface 설정
    name                  = "fg1-vpn"
    interface             = "wan1"
    proposal_phase1       = "aes256-sha1"  
    remote_gw             = "1.1.2.2"
    psksecret	          = "PreSharedKey"
    
    ### IPsec VPN Phase2-interface 설정
    proposal_phase2       = "aes256-sha1"
    auto_negotiate        = "enable"       

    ### System Interface 설정
    vdom                  = "root"         
    ip                    = "2.2.1.1 255.255.255.255"
    remote_ip             = "2.2.1.2 255.255.255.252"
    allowaccess           = "ping"         
}
```

## 3. VLAN Module

```
module "vlan10" {
    source                = "./modules/interface"

    name                  = "vlan10"
    vdom                  = "root"         
    device_identification = "enable"
    role                  = "lan"
    interface             = "internal1"
    vlanid                = 10             
}

module "vlan20" {
    source                = "./modules/interface"

    name                  = "vlan20"
    vdom                  = "root"         
    device_identification = "enable"
    role                  = "lan"
    interface             = "internal1"
    vlanid                = 20             
}
```

## 4. VXVLAN Module

```
module "vxlan10" {
    source                = "./modules/vxlan"

    name                  = "vxlan.10"
    interface             = "fg1-vpn"
    vni                   = 10
    remote_ip             = "2.2.1.2"

    depends_on             = [ module.vlan10 ]
}

module "vxlan20" {
    source                = "./modules/vxlan"

    name                  = "vxlan.20"
    interface             = "fg1-vpn"
    vni                   = 20
    remote_ip             = "2.2.1.2"

    depends_on            = [ module.vlan20 ]
}
```

## 5. Switch Interface Module

```
module "vxlan10svi" {
    source                = "./modules/switch-interface"

    name                  = "vxlan10"
    vdom                  = "root"         
    member                = [ 
      { interface_name    = "vlan10" },
      { interface_name    = "vxlan.10" }
    ]

    depends_on             = [ module.vxlan10 ]
}

module "vxlan20svi" {
    source                = "./modules/switch-interface"

    name                  = "vxlan20"
    vdom                  = "root"         
    member                = [ 
      { interface_name    = "vlan20" },
      { interface_name    = "vxlan.20" }
    ]

    depends_on            = [ module.vxlan20 ]
}
```

## 6. LLCF Module(1)

LLCF(Link Loss Carry Forward)는 link 상태를 감지하여 회선의 양 끝단 link를 up 또는 down 시키는 역할을 합니다.

wan1 인터페이스 상태를 감지하여 internal1 인터페이스를 up 또는 down 시킵니다. 또는

internal1 인터페이스 상태를 감지하여 wan1 인터페이스를 up 또는 down 시킵니다.

```
module "llcf_wan1" {
    source                = "./modules/interface"

    name                  = "wan1"
    vdom                  = "root"         
    fail_detect           = "enable"
    fail_detect_option    = "link-down"
    fail_alert_method     = "link-down"
    fail_alert_interface  = [
        { name            = "internal1" }
    ]    

    autogenerated         = "auto"
}

module "llcf_internal1" {
    source                = "./modules/interface"

    name                  = "internal7"
    vdom                  = "root"         
    fail_detect           = "enable"
    fail_detect_option    = "link-down"
    fail_alert_method     = "link-down"
    fail_alert_interface  = [
        { name            = "wan1" }
    ]    

    autogenerated         = "auto"
}
```

## 7. LLCF Module(2)

VPN Tunnel 상태를 감지하여 internal1 인터페이스를 up 또는 down 시킵니다.

FortiOS Event중 Log ID 37138에 해당하는 IPsec connection status changed를 이용합니다.

Log 의 action 필드 값 중 tunnel-down, tunnel-up 만 필터링하여 trigger를 작성합니다.

```
module "vpn-down-llcf" {
    source                = "../modules/automation"

    # system automation-action
    action_name           = "internal1_down"
    accprofile            = "api_super_admin"
    action_type           = "cli-script"
    required              = "enable"
    script                = "config system interface\nedit internal1\nset status down\nend"

    # system automation-trigger
    event_type            = "event-log"
    logid                 = "37138"
    fields                = [{
      id                  = "1"
      name                = "action"
      value               = "tunnel-down"
    }]

    # system automation-stitch
    stitch_name           = "IPsec_VPN_tunnel_down"
    status                = "enable"
    trigger               = "IPsec_VPN_tunnel_down"
    action                = [
      { name              = "internal1_down" }
    ]
}
```

```
module "vpn-up-llcf" {
    source                = "../modules/automation"

    # system automation-action
    action_name           = "internal1_up"
    accprofile            = "api_super_admin"
    action_type           = "cli-script"
    required              = "enable"
    script                = "config system interface\nedit internal1\nset status up\nend"

    # system automation-trigger
    event_type            = "event-log"
    logid                 = "37138"
    fields                = [{
      id                  = "1"
      name                = "action"
      value               = "tunnel-up"
    }]

    # system automation-stitch
    stitch_name           = "IPsec_VPN_tunnel_up"
    status                = "enable"
    trigger               = "IPsec_VPN_tunnel_up"
    action                = [
      { name              = "internal1_up" }
    ]
}
```